---
layout: post
title: "Color transformations for segmenting complex images"
author: ericminikel
date: 2012-05-13 16:18:01
---
<p>Over the past several weeks I&#8217;ve spent a lot of time playing with both <a href="/2012/03/27/turaga-murray-2010-convolutional-networks/">convolutional networks</a> and <a href="/2012/03/24/kamentsky-2011-improved-structure-function-and-compatibility-for-cellprofiler-modular-high-throughput-image-analysis-software/">CellProfiler</a>, trying to find a good way to segment the mouse brain images.  It&#8217;s not easy.  CellProfiler does really great with immunostaining where you&#8217;ve got bright fluorescent cells, uniformly sized and shaped, against a black background.  In fact, even without changing any of the default settings you can get a pretty bomb segmentation going:</p>
<p><a href="/wp-content/uploads/2012/05/p-immunostaining-segmentation.jpg"><img class="alignnone size-large wp-image-557" title="p-immunostaining-segmentation" src="/wp-content/uploads/2012/05/p-immunostaining-segmentation-1024x257.jpg"/></a></p>
<p>(Left: uniform immortalized cells with three stains, the blue of which is <a href="http://en.wikipedia.org/wiki/DAPI">DAPI</a> staining the nuclei; Center: just the blue color channel; Right: an almost perfect segmentation by CellProfiler without changing a setting)</p>
<p>Not so much for light microscopy (i.e. measuring reflection, not emission) from multi-stained in vivo sections with a lot of different cell types.  Watch while CellProfiler totally strikes out on segmenting this H&amp;E mouse brain image (scale bar 100 um):</p>
<p><a href="/wp-content/uploads/2012/05/p-he-segmentation.jpg"><img class="alignnone size-large wp-image-558" title="p-he-segmentation" src="/wp-content/uploads/2012/05/p-he-segmentation-1024x259.jpg"/></a></p>
<p>(left: original; center: grayscale by averaging &amp; inverting RGB; right: CellProfiler&#8217;s segmentation with all default settings)</p>
<p>I figured CellProfiler surely can do better than this&#8211; it is a rather large software package with a LOT of different segmentation settings, it&#8217;s just that the typical biologist (or even bioinformatician) using it doesn&#8217;t know the difference between the Otsu Global and MoG Adaptive thresholding methods and won&#8217;t know how to pick the settings that will work for their images.  So I spent much of the last few weeks implementing a machine learning approach in Python that cycles through the different CellProfiler settings to see which performs best against a provided ground truth.  With this I was eventually able to do a bit better, but still not well enough for any real analysis:</p>
<p><a href="/wp-content/uploads/2012/05/p-ml-segmentation1.jpg"><img class="alignnone  wp-image-567" title="p-ml-segmentation1" src="/wp-content/uploads/2012/05/p-ml-segmentation1.jpg"/></a></p>
<p>&nbsp;</p>
<p>(left: Source image, center: Manually drawn ground truth showing astrocyte nuclei (small), neuron nuclei (big), and blood vessels (squiggly).  right: Best segmentation found after 400 iterations of a genetic algorithm on CellProfiler settings.  This segmentation has a <a href="/2012/04/13/convolutional-networks-continued/">Rand index</a> of .86.  It found many of the desired objects but a lot of extra stuff as well).</p>
<p>So far I haven&#8217;t been able to do a whole lot better with my convolutional network implementation in Python either.  This I think is largely because I still haven&#8217;t quite worked out all the bugs in my implementation:</p>
<p><a href="/wp-content/uploads/2012/05/p-convnet-output.jpg"><img class="alignnone size-large wp-image-561" title="p-convnet-output" src="/wp-content/uploads/2012/05/p-convnet-output-1024x227.jpg"/></a></p>
<p>(left: Small source image used for testing; mid-left: Grayscale (averaged) inverted version; mid-right: Ground truth; right: Output of convolutional network)</p>
<p>But all this is just setting the stage for the real topic I&#8217;m writing about today, which is color transformations.  See, a fact that I glossed over pretty quickly above is how to create a segmentable grayscale image from a color one.  The most obvious approach: average the RGB channels.  What a way to lose a lot of information!  Look at these two images.  The neurons in the background are hard enough to see in the color image, but at least their blue tinge helps give them away; in the grayscale they are really faint.</p>
<p><a href="/wp-content/uploads/2012/05/p-grayscale-avg.jpg"><img class="alignnone  wp-image-562" title="p-grayscale-avg" src="/wp-content/uploads/2012/05/p-grayscale-avg.jpg"/></a></p>
<p>So I went hunting around in the literature for better things to do with my RGB channels than just average them.  The first thing I found is <a href="http://lcib.rutgers.edu/~james/quantcolor.pdf">Ruifrok&#8217;s seminal 2001 piece introducing color deconvolution</a>, which recently celebrated its 18 billionth citation.  The basic idea is this.  You know the optical densities in each color channel of each individual stain you&#8217;re using and you put them in a matrix, e.g.:</p>
<p><a href="/wp-content/uploads/2012/05/p-eq1.jpg"><img class="alignnone size-medium wp-image-563" title="p-eq1" src="/wp-content/uploads/2012/05/p-eq1-300x106.jpg"/></a></p>
<p>Then you take the inverse* of that matrix:<br/>
(*more on this &#8220;inverse&#8221; business later)</p>
<p><a href="/wp-content/uploads/2012/05/p-eq2.jpg"><img class="alignnone size-full wp-image-564" title="p-eq2" src="/wp-content/uploads/2012/05/p-eq2.jpg"/></a></p>
<p>Then you multiply each pixel in your image by the inverse, and if you had n stains you get out n grayscale images, one representing each stain&#8217;s contribution to the original image:</p>
<p><a href="/wp-content/uploads/2012/05/p-eq3.jpg"><img class="alignnone  wp-image-565" title="p-eq3" src="/wp-content/uploads/2012/05/p-eq3.jpg"/></a></p>
<p>In the above example, a particular pixel with R = 160, G = 251, B = 68 is deconvoluted to give a value of ~232 for hematoxylin and ~89 for eosin.  By doing this to every pixel you would come up with two grayscale images, one for each stain.</p>
<p>Brilliant!  Look at how much more the neurons pop out from the background when I use color deconvolution than when I simply average the channels:</p>
<p><a href="/wp-content/uploads/2012/05/p-avg-vs-colordeconv.jpg"><img class="alignnone  wp-image-566" title="p-avg-vs-colordeconv" src="/wp-content/uploads/2012/05/p-avg-vs-colordeconv.jpg"/></a></p>
<p>(left: RGB channels averaged and inverted.  right: The hematoxylin stain image obtained by color deconvolution.)</p>
<p>*Note on matrix inversion.  My understanding is that for color deconvolution, you actually only need the <em>right inverse</em>, and thus it can be done with any matrix size, a fact which Ruifrok sidesteps by happening to choose an example with 3 stains which conveniently gives you a 3&#215;3 matrix of which you can take a true inverse.  After reading the paper I was a bit confused on this point, but CellProfiler&#8217;s implementation of this concept (the UnmixColors module) simply does this to get the inverse matrix:</p>
<pre>        return np.array(absorbance_matrix.I[:,idx]).flatten()</pre>
<p>They use <a href="http://www.scipy.org/Tentative_NumPy_Tutorial">numpy</a>&#8216;s <a href="http://www.scipy.org/Tentative_NumPy_Tutorial#head-926a6c9b68b752eed8a330636c41829e6358b1d3">matrix.I</a> operation, which <em>does</em> work on non-square matrices and indeed it turns out CellProfiler will let you unmix colors for any number of stains.</p>
<p>OK, so color deconvolution was a big help and my machine learning algorithm was able to do a bit better on the hematoxylin grayscale image than the averaged grayscale image:</p>
<p><a href="/wp-content/uploads/2012/05/p-ml-segmentation.jpg"><img class="alignnone size-large wp-image-559" title="p-ml-segmentation" src="/wp-content/uploads/2012/05/p-ml-segmentation-1024x512.jpg"/></a></p>
<p>(right: This segmentation achieved a Rand index of .88, a bit better than by averaging to grayscale.  it has fewer extra objects but still a lot of splits).</p>
<p>But it&#8217;s still full of splits and mergers.  In part, I&#8217;ve got some work to do on the machine learning approach&#8211;the scoring metric could use some work, and I may not have varied the continuous-valued settings widely enough or finely enough.  But I also found some more recent work that takes color transformations several steps further in terms of complexity:</p>
<p><a href="http://ieeexplore.ieee.org/xpl/login.jsp?tp=&amp;arnumber=5746646">Kong H, Gurcan M, Belkacem-Boussaid K. 2011. Partitioning Histopathological Images: An Integrated Framework for Supervised Color-Texture Segmentation and Cell Splitting. IEEE Trans Med Imaging 30(1):1661-1677</a></p>
<p>The angle here is they use a ground truth classifying the image into two classes (nucleus and extracellular) in order to machine learn an optimized most discriminant color space (MDC) which they then use for segmentation.  They also do a lot of heavy duty post-processing, using radial symmetry and concavity detection to find and split touching cell clumps.  If you like matrices, you&#8217;ll love this paper.  The performance they show their algorithm achieving is certainly better than anything I&#8217;ve gotten so far!  This may be a new angle to explore.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
